import { GoogleGenAI } from '@google/genai';

const apiKey = process.env.VITE_GEMINI_API_KEY || '';
const genAI = apiKey ? new GoogleGenAI({ apiKey }) : null;

export interface AIContentSuggestion {
  title?: string;
  content?: string;
  excerpt?: string;
  tags?: string[];
  seoKeywords?: string[];
}

export interface SEOAnalysis {
  score: number;
  suggestions: string[];
  keywords: string[];
  readability: number;
}

export class GeminiAIService {
  private async generateText(prompt: string): Promise<string> {
    if (!genAI) {
      throw new Error('Gemini API key not configured');
    }

    try {
      const response = await genAI.models.generateText({
        model: 'gemini-2.0-flash-exp',
        prompt: prompt
      });
      return response?.trim() || '';
    } catch (error) {
      console.error('AI Generation Error:', error);
      throw new Error('Failed to generate content with AI');
    }
  }

  /**
   * Generate blog content using AI
   */
  async generateBlogContent(prompt: string, topic: string, tone: string = 'professional'): Promise<string> {
    try {
      const fullPrompt = `You are a professional content writer for a tech company called Coaxia. 
Write a comprehensive blog post about: ${topic}

Requirements:
- Tone: ${tone}
- Length: 1500-2000 words
- Include relevant sections with headings
- Make it engaging and informative
- Include practical examples
- Target audience: Tech professionals and business leaders

Additional context: ${prompt}

Write the complete blog post in Markdown format:`;

      return await this.generateText(fullPrompt);
    } catch (error) {
      console.error('Error generating blog content:', error);
      throw new Error('Failed to generate blog content');
    }
  }

  /**
   * Generate SEO-optimized meta description
   */
  async generateMetaDescription(title: string, content: string): Promise<string> {
    try {
      const prompt = `Create a compelling SEO meta description (150-160 characters) for this blog post:
Title: ${title}
Content summary: ${content.substring(0, 500)}...

The meta description should:
- Be exactly 150-160 characters
- Include primary keywords
- Be compelling and click-worthy
- Accurately represent the content

Return only the meta description:`;

      const result = await this.model.generateContent(prompt);
      return result.response.text().trim();
    } catch (error) {
      console.error('Error generating meta description:', error);
      throw new Error('Failed to generate meta description');
    }
  }

  /**
   * Generate relevant tags for content
   */
  async generateTags(title: string, content: string, count: number = 5): Promise<string[]> {
    try {
      const prompt = `Analyze this blog post and generate ${count} relevant tags:
Title: ${title}
Content: ${content.substring(0, 1000)}...

Requirements:
- Generate exactly ${count} tags
- Tags should be relevant to the content
- Use popular industry terms
- Keep tags concise (1-3 words)
- Return as a comma-separated list

Return only the tags:`;

      const result = await this.generateText(prompt);
      const tags = result.trim().split(',').map(tag => tag.trim());
      return tags.slice(0, count);
    } catch (error) {
      console.error('Error generating tags:', error);
      throw new Error('Failed to generate tags');
    }
  }

  /**
   * Perform SEO analysis
   */
  async analyzeSEO(title: string, content: string, metaDescription?: string): Promise<SEOAnalysis> {
    try {
      const prompt = `Perform SEO analysis for this content:
Title: ${title}
Content length: ${content.length} characters
Meta Description: ${metaDescription || 'Not provided'}
Content preview: ${content.substring(0, 500)}...

Analyze and provide:
1. SEO score (0-100)
2. List of improvement suggestions
3. Recommended keywords (5-10)
4. Readability score (0-100)

Return response in this exact JSON format:
{
  "score": <number>,
  "suggestions": ["suggestion1", "suggestion2", ...],
  "keywords": ["keyword1", "keyword2", ...],
  "readability": <number>
}`;

      const result = await this.model.generateContent(prompt);
      const text = result.response.text().trim();
      
      // Extract JSON from response
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        return JSON.parse(jsonMatch[0]);
      }
      
      // Fallback
      return {
        score: 70,
        suggestions: ['Add more keywords', 'Improve meta description', 'Use more headings'],
        keywords: ['technology', 'software', 'development'],
        readability: 75
      };
    } catch (error) {
      console.error('Error analyzing SEO:', error);
      throw new Error('Failed to analyze SEO');
    }
  }

  /**
   * Improve existing content
   */
  async improveContent(content: string, focus: string = 'general'): Promise<string> {
    try {
      const prompt = `Improve the following content. Focus on: ${focus}

Original content:
${content}

Requirements:
- Maintain the original message
- Improve clarity and readability
- Fix grammar and spelling
- Enhance engagement
- Keep the same length approximately

Return only the improved content:`;

      const result = await this.model.generateContent(prompt);
      return result.response.text().trim();
    } catch (error) {
      console.error('Error improving content:', error);
      throw new Error('Failed to improve content');
    }
  }

  /**
   * Generate product description
   */
  async generateProductDescription(name: string, features: string[], category: string): Promise<string> {
    try {
      const prompt = `Create a compelling product description for:
Product Name: ${name}
Category: ${category}
Key Features: ${features.join(', ')}

Requirements:
- Write 200-300 words
- Highlight unique value propositions
- Use persuasive language
- Include benefits, not just features
- Professional tone
- Make it compelling for tech buyers

Return only the description:`;

      const result = await this.model.generateContent(prompt);
      return result.response.text().trim();
    } catch (error) {
      console.error('Error generating product description:', error);
      throw new Error('Failed to generate product description');
    }
  }

  /**
   * Generate job description
   */
  async generateJobDescription(
    title: string,
    department: string,
    level: string
  ): Promise<{ description: string; responsibilities: string[]; requirements: string[] }> {
    try {
      const prompt = `Create a professional job description for:
Position: ${title}
Department: ${department}
Level: ${level}

Generate:
1. A compelling job description (150-200 words)
2. 5-7 key responsibilities
3. 5-7 requirements

Return in this JSON format:
{
  "description": "...",
  "responsibilities": ["...", "..."],
  "requirements": ["...", "..."]
}`;

      const result = await this.model.generateContent(prompt);
      const text = result.response.text().trim();
      
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        return JSON.parse(jsonMatch[0]);
      }
      
      throw new Error('Invalid response format');
    } catch (error) {
      console.error('Error generating job description:', error);
      throw new Error('Failed to generate job description');
    }
  }

  /**
   * Generate content ideas
   */
  async generateContentIdeas(topic: string, count: number = 5): Promise<string[]> {
    try {
      const prompt = `Generate ${count} creative blog post ideas about: ${topic}

Requirements:
- Ideas should be relevant to a tech/software company
- Mix of tutorial, case study, and thought leadership topics
- Each idea should be compelling and specific
- Return as a numbered list

Return only the ideas:`;

      const result = await this.generateText(prompt);
      const text = result.trim();
      const ideas = text.split('\n').filter(line => line.trim()).map(line => 
        line.replace(/^\d+\.\s*/, '').trim()
      );
      return ideas.slice(0, count);
    } catch (error) {
      console.error('Error generating content ideas:', error);
      throw new Error('Failed to generate content ideas');
    }
  }

  /**
   * Smart content assistant for general queries
   */
  async assistContent(query: string, context?: string): Promise<string> {
    try {
      const prompt = `You are an AI assistant helping manage a tech company's content.
${context ? `Context: ${context}\n` : ''}
User query: ${query}

Provide helpful, actionable advice:`;

      const result = await this.model.generateContent(prompt);
      return result.response.text().trim();
    } catch (error) {
      console.error('Error in content assistant:', error);
      throw new Error('Failed to assist with content');
    }
  }
}

export const geminiService = new GeminiAIService();
